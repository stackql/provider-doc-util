# provider-doc-util
> Command line utility to help developers prepare and submit StackQL provider specs, see [StackQL Readme](https://github.com/stackql/stackql/blob/main/README.md)

## Installation

<details>
<summary>NPM</summary>
<p>

```bash
npm i @stackql/provider-doc-util
```

</p>
</details>

<details>
<summary>YARN</summary>
<p>

```bash
yarn add @stackql/provider-doc-util
```

</p>
</details>

## Setup

from the package directory, run:

```bash
npm link
```

## Usage

```bash
provider-doc-util <command> <apiDoc or providerDevDocRoot> <stackqlProviderName> [<stackqlProviderVersion>] [<OPTIONS>]
```

### Commands

__`dev`__  

Creates StackQL provider development docs and splits an API into service scoped documents based upon a specified discriminator (optional).  Development docs will parse a providers API and map default routes for StackQL query and DML operations, these can be modified or enriched by the developer.  For convinience, development docs can be generated in `json`, `yaml`, `toml` or `hcl` formats.  The development docs are then assembled using the __build__ command and then can be tested locally see [Test Using a Local Registry](#test-using-a-local-registry).  Once you have tested locally you can raise a pull request to [stackql/stackql-provider-registry](https://github.com/stackql/stackql-provider-registry).    

__`build`__  

Assembles StackQL development docs into a registry compatible format, ready to use as a local registry for testing or to raise a pull request to [stackql/stackql-provider-registry](https://github.com/stackql/stackql-provider-registry).  


### Options

__`--svcDiscriminator`, `-s`__  *JSONPath expression* OR *svcName:servicename*

blah  

__`--resDiscriminator`, `-r`__  *JSONPath expression*  

blah

__`--methodkey`, `-m`__  *JSONPath expression*  

blah

__`--output`, `-o`__  *directory*  

blah

__`--format`, `-f`__  *yaml | json | toml | hcl*  

blah

__`--debug`, `-d`__  

blah


## Example

This example demonstrates creating a StackQL provider for `github` and testing this provider locally using `stackql`


### Example Project Structure

The following directory structure represents the target after an API dev workspace is set up and the StackQL provider for `github` is built.


```
local-registry/
├─ dev/
│  ├─ github/
│  │  ├─ v1/
│  │  │  ├─ provider.yaml
│  │  │  ├─ services/
│  │  │  │  ├─ repos/
│  │  │  │  │  ├─ repos-v1.yaml
│  │  │  │  │  ├─ repos-v1-resources.yaml
│  │  │  │  ├─ .../
├─ ref/
│  ├─ github/
│  │  ├─ api.github.com.yaml
├─ src/
│  ├─ github/
│  │  ├─ v1/
│  │  │  ├─ provider.json
│  │  │  ├─ services/
│  │  │  │  ├─ repos/
│  │  │  │  │  ├─ repos-v1.json
```

`local-registry/ref/github/api.github.com.yaml` is the source OpenAPI 3 specification for the `github` api, this was sourced from [GitHub](https://github.com/github/rest-api-description/blob/main/descriptions/api.github.com/api.github.com.yaml).  

The `dev` directory contains the output of the dev docs generated by `provider-doc-util dev`,  

The `src` directory contains the output of the StackQL provider interface generated from the dev docs using `provider-doc-util build`.  


### Create Working Provider Docs

PowerShell:  

```powershell
provider-doc-util dev `
ref/github/api.github.com.yaml `
github `
v1 `
-s "$['x-github'].category" `
-r "$['x-github'].subcategory" `
-o ./dev `
-f toml
```

#### linux
`provider-doc-util api.github.com.yaml github v1 -s '$["x-github"].category' -r '$["x-github"].subcategory'`


### Build Provider Docs


PowerShell:  

```powershell
provider-doc-util `
build `
./dev `
github `
v1 `
-o ./src
```

### Test Using a Local Registry

```
cd local-registry
PROVIDER_REGISTRY_ROOT_DIR="$(pwd)"
REG_STR='{"url": "file://'${PROVIDER_REGISTRY_ROOT_DIR}'", "localDocRoot": "'${PROVIDER_REGISTRY_ROOT_DIR}'", "verifyConfig": {"nopVerify": true}}'
AUTH_STR='{"github": { "type": "null_auth" }}'
./stackql shell --auth="${AUTH_STR}" --registry="${REG_STR}"
```